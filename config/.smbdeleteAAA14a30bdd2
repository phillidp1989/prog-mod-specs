/**
 * Security Configuration
 * Centralizes all security-related settings
 */

const rateLimit = require('express-rate-limit');
const helmet = require('helmet');

/**
 * Rate Limiting Configuration
 */
const rateLimiters = {
  // General API rate limiter
  api: rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100, // Limit each IP to 100 requests per windowMs
    message: { error: 'Too many requests from this IP, please try again later.' },
    standardHeaders: true, // Return rate limit info in the `RateLimit-*` headers
    legacyHeaders: false, // Disable the `X-RateLimit-*` headers
  }),

  // Autocomplete endpoints (more frequent usage expected)
  autocomplete: rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 50,
    message: { error: 'Too many autocomplete requests, please slow down.' },
    standardHeaders: true,
    legacyHeaders: false,
  }),

  // Download endpoints (more restricted)
  download: rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 20,
    message: { error: 'Too many download requests, please try again later.' },
    standardHeaders: true,
    legacyHeaders: false,
  }),
};

/**
 * CORS Configuration
 */
const corsOptions = {
  origin: function (origin, callback) {
    // Allow requests with no origin (like mobile apps or curl requests)
    if (!origin) return callback(null, true);

    const allowedOrigins = process.env.ALLOWED_ORIGINS
      ? process.env.ALLOWED_ORIGINS.split(',')
      : ['http://localhost:8080', 'http://localhost:3000'];

    if (allowedOrigins.indexOf(origin) !== -1 || process.env.NODE_ENV === 'development') {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  optionsSuccessStatus: 200
};

/**
 * Helmet Configuration (Security Headers)
 */
const helmetOptions = helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: [
        "'self'",
        "'unsafe-inline'", // Required for inline scripts in HTML
        "'unsafe-eval'", // Required for Alpine.js, docxtemplater, and pizzip
        "https://cdn.jsdelivr.net", // For Lucide icons and other CDN resources
        "https://unpkg.com", // For Alpine.js and Chart.js
        "https://cdn.tailwindcss.com", // For Tailwind CSS CDN
        "https://cdnjs.cloudflare.com" // For jQuery and other libraries
      ],
      styleSrc: [
        "'self'",
        "'unsafe-inline'", // Required for Tailwind and inline styles
        "https://cdn.jsdelivr.net",
        "https://cdn.tailwindcss.com" // For Tailwind CSS CDN
      ],
      imgSrc: [
        "'self'",
        "data:", // For base64 images
        "https:" // Allow HTTPS images
      ],
      connectSrc: [
        "'self'",
        process.env.SUPABASE_URL || "*" // Allow Supabase connections
      ],
      fontSrc: ["'self'", "data:", "https://cdn.jsdelivr.net"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'none'"],
    },
  },
  crossOriginEmbedderPolicy: false, // May cause issues with some CDN resources
  crossOriginResourcePolicy: { policy: "cross-origin" },
});

/**
 * Additional security middleware configurations
 */
const securityConfig = {
  // Prevent parameter pollution
  hpp: {
    whitelist: ['year', 'cohort', 'progCode', 'modCode']
  },

  // Trust proxy (important if behind nginx/apache)
  trustProxy: process.env.NODE_ENV === 'production' ? 1 : false,
};

/**
 * Environment variable validation
 * Call this at server startup
 */
function validateEnvironmentVariables() {
  const required = ['SUPABASE_URL', 'SUPABASE_ANON_KEY'];
  const missing = [];

  required.forEach(varName => {
    if (!process.env[varName]) {
      missing.push(varName);
    }
  });

  if (missing.length > 0) {
    throw new Error(`Missing required environment variables: ${missing.join(', ')}`);
  }

  console.log('âœ“ Environment variables validated');
}

/**
 * Get security middleware stack
 * Returns array of middleware in correct order
 */
function getSecurityMiddleware() {
  return [
    helmetOptions,
    // CORS is applied separately with app.use(cors(corsOptions))
  ];
}

module.exports = {
  rateLimiters,
  corsOptions,
  helmetOptions,
  securityConfig,
  validateEnvironmentVariables,
  getSecurityMiddleware
};
